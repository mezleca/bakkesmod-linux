name: injector_release
on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            injector_version: ${{ steps.build.outputs.version }}
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: install dependencies
              if: runner.os == 'Linux'
              run: |
                    sudo apt-get update
                    sudo apt-get install -y build-essential cmake ninja-build mingw-w64

            - name: ensure build perms
              run: chmod +x ./build.py

            - name: configure
              run: ./build.py configure

            - name: build
              run: ./build.py build

            - name: extract injector version
              run: |
                    VERSION=$(./build.py version)
                    echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: upload artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: build
                  path: |
                      build/simple_injector.exe

    release:
        needs: [build]
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: download artifacts
              uses: actions/download-artifact@v5
              with:
                  name: build
                  path: artifacts/

            - name: list artifacts
              run: |
                  echo "[log] listing artifacts directory:"
                  ls -la artifacts/ || echo "[log] no artifacts directory found"

            - name: create or update release
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ needs.build.outputs.injector_version }}
                  tag_name: ${{ needs.build.outputs.injector_version }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: artifacts/*
                  token: ${{ secrets.GITHUB_TOKEN }}
